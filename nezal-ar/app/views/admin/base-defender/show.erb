<script type='text/javascript'>

var Game = {
  
  metadata : null,

  initialize : function(){
    new Ajax.Request( '/<%=AdminController::ADMIN_URL%>/<%=@game[:name]%>/metadata' , {
                     method : 'get',
                     onSuccess : function(response){
                        Game.metadata = JSON.parse(response.responseText)
                        if(!Game.metadata['languages']) 
                          Game.metadata['languages'] = {};
                        Game.displayLanguages();
                     }
                    });
  },

  displayLanguages : function(){
    $('languages').innerHTML = TrimPath.processDOMTemplate("languageTemplate");
  }, 

  deleteLanguage : function(lang){
    delete(this.metadata.languages[lang]);
    this.saveToServer();
  },

  addLanguage : function(lang){
    this.metadata.languages[lang] = {};
    this.saveToServer();
  },

  saveToServer : function(){
    new Ajax.Request( '/<%=AdminController::ADMIN_URL%>/<%=@game[:name]%>/metadata' , {
                      method : 'put',
                      parameters : { "data" : JSON.stringify(this.metadata) },
                      onSuccess : function(response){
                        Game.showSuccessMsg();
                        Game.initialize();  
                      },
                      onFailure : function(response){
                        Game.showErrorMsg();
                      }
                     
                 });    
  },

  showSuccessMsg : function(){
    $('langReqStatus').innerHTML = "Saved successfully"
    $('langReqStatus').className = "success"
    $('langReqStatus').show();
    window.setTimeout( function(){$('langReqStatus').hide()}, 5000 )
  },

  showErrorMsg : function(){
    $('langReqStatus').innerHTML = "Error, your changes are not saved!"
    $('langReqStatus').className = "error"
    $('langReqStatus').show();
    window.setTimeout( function(){$('langReqStatus').hide()}, 10000 )
  }

};

var data = <%=JSON.generate(@game.metadata)%>
for(i in data.buildings)
{
  data.buildings[i]['defense'] = false;
}
['wedge', 'gaddafi','palm'].each(function(name){
                            data.buildings[name]['defense'] = true;
                          });
new Ajax.Request( '/<%=AdminController::ADMIN_URL%>/<%=@game[:name]%>/metadata' , {
                   method : 'put',
                   parameters : { "data" : JSON.stringify(data) },
                   onSuccess : function(response){
                     $('requestStatus').innerHTML = "Saved successfully"
                     $('requestStatus').className = "success"
                   },
                   onFailure : function(response){
                     $('requestStatus').innerHTML = "Error, your changes are not saved!"
                     $('requestStatus').className = "error"
                   }
                   
               });    

deleteAllUserProfiles = function(){
  new Ajax.Request('/<%=AdminController::ADMIN_URL%>/<%=@game[:name]%>/user_game_profiles', {
    method: 'put',
    onSuccess: function(response){
      $('requestStatus').innerHTML = "Deleted successfully"
      $('requestStatus').className = "success"
    },
    onFailure: function(response){
      $('requestStatus').innerHTML = "Error, cannot delete!"
      $('requestStatus').className = "error"
    }
  })
};    
</script>

<div id="backLink">   
  <a href="/<%=AdminController::ADMIN_URL%>/<%=@game[:name]%>/">
    Back
  </a>
</div>

<button onclick="if(confirm('Delete ALL user game profiles? ( can not delete more than 50 )')) deleteAllUserProfiles();"> Delete ALL user game profiles </button>
 We currently have <%= UserGameProfile.count %> Player(s)
 <br/>
 <span id="requestStatus"></span>

<div class="separator"></div>

<LABEL for="game" class="label">Buildings</LABEL>

<div class="game">
  <% game_element = "buildings" %>
  <% @game.metadata[game_element].each_key do | building_name | %>
    <label style="font-size: 15px; color:orange;"><%= building_name.capitalize %></label>
	  <% if @game.metadata[game_element][building_name]["levels"].present? %>
		  <div id="<%=building_name%>">
        <% @game.metadata[game_element][building_name]["levels"].each_key do |level|%>
          <% if level != "0" %>
  				  <a href="edit/building/<%= building_name %>/level/<%=level%>">Level <%= level %></a>
            <% if level == (@game.metadata[game_element][building_name]["levels"].size-1).to_s && level != "1" %>
    			    <form id="delete_<%=building_name%>_level_<%=level%>" 
                    action="/<%=AdminController::ADMIN_URL%>/<%=@game[:name]%>/building/<%=building_name%>/level/<%=level%>" 
                    method="POST" 
                    style="display:inline">
                          <input type="hidden" name="_method" value="put"/>
                          <a style="margin-left: 25px;" 
                             href="javascript:void(0)" 
                             onclick="if(confirm('Delete <%=building_name%> level <%=level%>?')) $('delete_<%=building_name%>_level_<%=level%>').submit(); return false;" 
                             class="submit_links"> Delete </a>
              </form>
            <% end %> 
  				  <br/>
          <% end %>
			  <%end%>
  		  <form id="add_<%=building_name%>_level" 
              action="/<%=AdminController::ADMIN_URL%>/<%=@game[:name]%>/building/<%=building_name%>/level/new" 
              method="POST" 
              style="display:inline">
                  <input type="hidden" name="_method" value="post"/>
                  <a href="javascript:void(0)" 
                     onclick="$('add_<%=building_name%>_level').submit(); return false;" 
                     class="submit_links"> Add next level </a>
        </form> 
	    </div>
	  <% end %>
    <br/>
  <% end %>
</div>


<div class="separator"></div>

<div id='languages' style="width:60%;">
</div>

<!-------------------- Language Template -------------------->
<span id="langReqStatus"></span>
<textarea id="languageTemplate" style="display:none;">
    <LABEL for="lang" class="label">Supported Languages</LABEL>
    <div class="languageList subItem">
    {for language in Game.metadata.languages}
	    <a href="/<%=AdminController::ADMIN_URL%>/<%=@game[:name]%>/locale/${language_index}/edit" class="column">${language_index}</a>
	    <a href="javascript:void(0)" onclick="Game.deleteLanguage('${language_index}');">Delete</a>
      <br/>
    {/for}
    </div>
    <LABEL for="lang" class="label">New Language</LABEL>
    <div id="addLang" class="form_row subItem">  
      <LABEL for="lang">Languege</LABEL>
      <INPUT type="text" id="lang" name='lang'>
    </div>
    <div class="form_row">  
      <input class="submit" type="submit" value="Add" onclick="Game.addLanguage($$('#languages #addLang #lang')[0].value);">
    </div>
</textarea>
<!-------------------- End Of Template ---------------------->
<script type='text/javascript'>
Game.initialize();
</script>
