<script type='text/javascript'>
var GameData = {
    towers : { 
             },
    weapons : {
            }, 
    upgrades : {
          },
    creeps : {
        },
    templates : {},

    init : function()
    {
        GameData.templates['towers'] = TrimPath.parseDOMTemplate('displayTemplate');
        GameData.templates['weapons'] = TrimPath.parseDOMTemplate('displayTemplate');
        GameData.templates['upgrades'] = TrimPath.parseDOMTemplate('displayTemplate');
        GameData.templates['creeps'] = TrimPath.parseDOMTemplate('displayCreepTemplate');
        new Ajax.Request( '../metadata' , {
                          method : 'get',
                          onSuccess: function(transport) {
                              data = JSON.parse(transport.responseText);
                              GameData.towers = data['towers'];
                              GameData.weapons = data['weapons'];
                              GameData.upgrades = data['upgrades'];
                              GameData.creeps = data['creeps'];
                              $$('#towers #list')[0].innerHTML = GameData.templates['towers'].process({list: GameData.towers, type : 'tower'});
                              $$('#weapons #list')[0].innerHTML = GameData.templates['weapons'].process({list: GameData.weapons, type : 'weapon'});
                              $$('#upgrades #list')[0].innerHTML = GameData.templates['upgrades'].process({list: GameData.upgrades, type : 'upgrade'});
                              $$('#creeps #list')[0].innerHTML = GameData.templates['creeps'].process({list: GameData.creeps, type : 'creeps'});
                          }
                      });
    },
    addTower : function()
    {
        var tower = {
            "name" : $$("#towers #addTower #name")[0].value.split(' ').join(''),
            "cost" : $$("#towers #addTower #cost")[0].value,
            "exp" : $$("#towers #addTower #exp")[0].value,
            "unlocked" : $$("#towers #addTower #unlocked")[0].checked
        }
        if( !(tower["name"]) || !(tower["cost"]) || !(tower["exp"]) || isNaN(tower["cost"]) || isNaN(tower["exp"]) )
        {
          alert("Name must exist & Cost and Experience points must be integers");
          return;
        }
        tower.cost = parseInt(tower.cost);
        tower.exp = parseInt(tower.exp);
        GameData.towers[tower['name']] = tower;
        $$("#towers #addTower #name")[0].value = "";
        $$("#towers #addTower #cost")[0].value = "";
        $$("#towers #addTower #exp")[0].value = "";
        $$("#towers #addTower #unlocked")[0].checked = false;
        $$('#towers #list')[0].innerHTML = GameData.templates['towers'].process({list: GameData.towers, type : 'tower'});
    },
    deleteTower : function(element)
    {
        delete GameData.towers[element.getAttribute('name')];
        $$('#towers #list')[0].innerHTML = GameData.templates['towers'].process({list: GameData.towers, type : 'tower'});
    },
    addWeapon : function()
    {
        var weapon = {
            "name" : $$("#weapons #addWeapon #name")[0].value.split(' ').join(''),
            "cost" : $$("#weapons #addWeapon #cost")[0].value,
            "package" : $$("#weapons #addWeapon #package")[0].value,
            "exp" : $$("#weapons #addWeapon #exp")[0].value,
        }
        if( !(weapon["name"]) || !(weapon["cost"]) || !(weapon["exp"]) || !(weapon["package"]) ||
            isNaN(weapon["cost"]) || isNaN(weapon['package']) || isNaN(weapon["exp"]))
        {
          alert("Name must exist & Cost and Experience points must be integers");
          return;
        }
        weapon.cost = parseInt(weapon.cost);
        weapon.package = parseInt(weapon.package);
        weapon.exp = parseInt(weapon.exp);
        GameData.weapons[weapon['name']] = weapon;
        $$("#weapons #addWeapon #name")[0].value = "";
        $$("#weapons #addWeapon #cost")[0].value = "";
        $$("#weapons #addWeapon #package")[0].value = "";
        $$("#weapons #addWeapon #exp")[0].value = "";
        $$("#weapons #list")[0].innerHTML = GameData.templates['weapons'].process({list: GameData.weapons, type : 'weapon'});
    },
    deleteWeapon : function(element)
    {
        delete GameData.weapons[element.getAttribute('name')];
        $$("#weapons #list")[0].innerHTML = GameData.templates['weapons'].process({list: GameData.weapons, type : 'weapon'});
    },
    addUpgrade : function()
    {
        var upgrade = {
            "name" : $$("#upgrades #addUpgrade #name")[0].value.split(' ').join(''),
            "cost" : $$("#upgrades #addUpgrade #cost")[0].value,
            "exp" : $$("#upgrades #addUpgrade #exp")[0].value,
            "unlocked" : $$("#upgrades #addUpgrade #unlocked")[0].checked
        }
        if( !(upgrade["name"]) || !(upgrade["cost"]) || !(upgrade["exp"]) || 
             isNaN(upgrade["cost"]) || isNaN(upgrade["exp"]) )
        {
          alert("Name must exist & Cost and Experience points must be integers");
          return;
        }
        upgrade.cost = parseInt(upgrade.cost);
        upgrade.exp = parseInt(upgrade.exp);
        GameData.upgrades[upgrade['name']] = upgrade;
        $$("#upgrades #addUpgrade #name")[0].value = "";
        $$("#upgrades #addUpgrade #cost")[0].value = "";
        $$("#upgrades #addUpgrade #exp")[0].value = "";
        $$("#upgrades #addUpgrade #unlocked")[0].checked = false;
        $$('#upgrades #list')[0].innerHTML = GameData.templates['upgrades'].process({list: GameData.upgrades, type : 'upgrade'});
    },
    deleteUpgrade : function(element)
    {
        delete GameData.upgrades[element.getAttribute('name')];
        $$("#upgrades #list")[0].innerHTML = GameData.templates['upgrades'].process({list: GameData.upgrades, type : 'upgrade'});
    },
    addCreep : function()
    {
        var creep = {
            "name" : $$("#creeps #addCreep #name")[0].value,
        }
        if(!creep["name"])
        {
          alert("Name must exist");
          return;
        }
        GameData.creeps[creep['name']] = creep;
        $$("#creeps #addCreep #name")[0].value = "";
        $$("#creeps #list")[0].innerHTML = GameData.templates['creeps'].process({list: GameData.creeps, type : 'creep'});
    },
    deleteCreep : function(element){
        delete GameData.creeps[element.getAttribute('name')];
        $$("#creeps #list")[0].innerHTML = GameData.templates['creeps'].process({list: GameData.creeps, type : 'creep'});
    },
    deleteElement : function(element)
    {
        type = element.getAttribute('type');
        if(type == 'tower')
        {
            GameData.deleteTower(element);
        }else if(type == 'weapon'){
            GameData.deleteWeapon(element);
        }else if(type == 'upgrade'){
            GameData.deleteUpgrade(element);
        }else if(type == 'creep'){ 
            GameData.deleteCreep(element);
        }
    }, 
    saveData : function()
    {
        data = { towers : GameData.towers, 
                  weapons : GameData.weapons,
                  upgrades : GameData.upgrades, 
                  creeps : GameData.creeps }
        new Ajax.Request( '../metadata' , {
                                    method : 'put',
                                    parameters : { "data" : JSON.stringify(data) },
                                    onSuccess: function(transport) {
                                      window.location = window.location
                                    }
                                });
                            
    }
}
$(document).observe('dom:loaded',function(){ GameData.init();});
</script>

<div id="game">

    <div id="backLink"> 
      <a href="/<%=AdminController::ADMIN_URL%>/<%=@game[:name]%>">
        Back
      </a>
    </div>

    <div id="game_name">
        <%=@game.name%>
    </div>
    <textarea id="displayTemplate" style="display:none;">
        {for element in list}
    		  	<div>
      	  	    <span class="column" style="width:26%;"> 
  	    	  	      <LABEL for="name">Name: </LABEL>
      	  	        ${element['name']} 
    	  	      </span>
          	    <span class="column" style="width:17%;"> 
                    <LABEL for="cost">Cost: </LABEL>  
          	        ${element['cost']} 
      	        </span>  
      	        {if (type=='weapon') }
          	    <span class="column" style="width:17%;"> 
                    <LABEL for="package">Package: </LABEL>  
          	        ${element['package']} 
      	        </span>  
    	          {/if}
          	    <span class="column" style="width:32%;"> 
                    <LABEL for="exp">Experience Points: </LABEL>  
          	        ${element['exp']} 
      	        </span>  
      	        {if (type!='weapon') }
          	    <span class="column" style="width:18%;"> 
                    <LABEL for="exp">Unlocked: </LABEL>  
          	        ${element['unlocked']} 
      	        </span>  
    	          {/if}
      	        <span class="delete" style="width:2%;">
                  <a name="${element['name']}" type="${type}" href="#" onclick="GameData.deleteElement(this);return false;" class="submit_links"> x </a>
                </span>
            </div>
            <div style="clear:both"></div>
        {/for}
    </textarea>
    <textarea id="displayCreepTemplate" style="display:none;">
        {for element in list}
    		  	<div>
      	  	    <span class="column"> 
  	    	  	      <LABEL for="name">Name: </LABEL>
      	  	        ${element['name']} 
    	  	      </span>
      	        <span class="delete" >
                  <a name="${element['name']}" type="${type}" href="#" onclick="GameData.deleteElement(this);return false;" class="submit_links"> x </a>
                </span>
            </div>
            <div style="clear:both"></div>
        {/for}
    </textarea>
    <div id="towers">
        <div class="title">Towers</div>
        <div id="list">
        </div>
        <div id="addTower" class="title add">
            <LABEL for="addTower" class="label">Add New Tower</LABEL>
            <div class="form_row">  
                <LABEL for="name">Name</LABEL>
                <INPUT type="text" id="name" name='name'><BR>
            </div>
            <div class="form_row">  
                <LABEL for="cost">Cost</LABEL>
                <INPUT type="text" id="cost" name='cost'><BR>
            </div>
            <div class="form_row">  
                <LABEL for="exp">Experience Points</LABEL>
                <INPUT type="text" id="exp" name='exp'><BR>
            </div>
            <div class="form_row">  
                <LABEL for="unlocked">Unlocked</LABEL>
                <INPUT type="checkbox" id="unlocked" name="unlocked" value="1"><BR>
            </div>
            <div class="form_row">
                <input type="submit" value="Add" class="submit" onclick="GameData.addTower(); return false;"/>
            </div>
        </div>      
	  </div>
    <div id="weapons">
        <div class="title">Weapons</div>
        <div id="list">
        </div>
        <div id="addWeapon" class="title add">
            <LABEL for="addWeapon"  class="label">Add New Weapon</LABEL>
            <div class="form_row">  
                <LABEL for="name">Name</LABEL>
                <INPUT type="text" id="name" name='name'><BR>
            </div>
            <div class="form_row">  
                <LABEL for="cost">Cost</LABEL>
                <INPUT type="text" id="cost" name='cost'><BR>
            </div>
            <div class="form_row">  
                <LABEL for="package">Package</LABEL>
                <INPUT type="text" id="package" name='package'><BR>
            </div>
            <div class="form_row">  
                <LABEL for="exp">Experience Points</LABEL>
                <INPUT type="text" id="exp" name='exp'><BR>
            </div>
            <div class="form_row">
                <input type="submit" value="Add" class="submit" onclick="GameData.addWeapon(); return false;"/>
            </div>
        </div>      
	  </div>
    <div id="upgrades">
        <div class="title">Upgrades</div>
        <div id="list">
        </div>
        <div id="addUpgrade" class="title add">
            <LABEL for="addUpgrade"  class="label">Add New Upgrade</LABEL>
            <div class="form_row">  
                <LABEL for="name">Name</LABEL>
                <INPUT type="text" id="name" name='name'><BR>
            </div>
            <div class="form_row">  
                <LABEL for="cost">Cost</LABEL>
                <INPUT type="text" id="cost" name='cost'><BR>
            </div>
            <div class="form_row">  
                <LABEL for="exp">Experience Points</LABEL>
                <INPUT type="text" id="exp" name='exp'><BR>
            </div>
            <div class="form_row">  
                <LABEL for="unlocked">Unlocked</LABEL>
                <INPUT type="checkbox" id="unlocked" name="unlocked" value="1"><BR>
            </div>
            <div class="form_row">
                <input type="submit" value="Add" class="submit" onclick="GameData.addUpgrade(); return false;"/>
            </div>
        </div>      
	  </div>
    <div id="creeps">
        <div class="title">Creeps</div>
        <div id="list">
        </div>
        <div id="addCreep" class="title add">
            <LABEL for="addCreep"  class="label">Add New Creep</LABEL>
            <div class="form_row">  
                <LABEL for="name">Name</LABEL>
                <INPUT type="text" id="name" name='name'><BR>
            </div>
            <div class="form_row">
                <input type="submit" value="Add" class="submit" onclick="GameData.addCreep(); return false;"/>
            </div>
        </div>      
	  </div>
    <div style="text-align : right;">
        <input type="submit" value="AM Done .. Save That" class="submit" onclick="GameData.saveData(); return false;"/>
    </div>

</div>

<style>
    #towers, #weapons, #upgrades, #creeps
    {
        padding : 20px;
        border-top : solid 1px;
    }
</style>


