/*
HTTP Host: static.ak.fbcdn.net
Generated: September 13th 2010 12:40:48 PM PDT
Machine: 10.30.148.192
Locale: nu_ll
Path: js/photos/photostream.js
*/

((location=='about:blank'&&(window.parent.eval_global||window.parent.eval))||(window.eval_global||window.eval))("if (window.CavalryLogger) { CavalryLogger.start_js([\"js\\\/photos\\\/photostream.js\"]); }\n\nfunction Photostream(e,k,f,d,u,o,q,c,l,h,m,a,n,t,b,g){Photostream.instance=this;if(k)(new Image()).src=k;if(ua.safari()<500||ua.firefox()<2)return;copy_properties(this,{data:copy_properties(d,{async:true,start_pos:q}),seq:0,pid:o,uid:u,img:e,minseq:0,isSearch:f});copy_properties(this,{error:0,album:new Array(c),has_moved:false,jumps:{},unseen:null,cursor:null,is_rendered:true,queue:new TaskQueue(),loads:[],pagesize:20,fetchedPages:{},numFetchedPages:0,pending:(m?1:0),readied:false,lastTimeout:null,slideshowSpeed:3000,slideshowActive:false,slideshowEventsInited:false,photoLoadTimeout:null,getPhotoSuggestions:n,netegoPagelet:null,endOfAlbumPhotos:4,keyboardDialogViews:g});this.setupDisplay();this.setupCaptions(u,o,t,b);copy_properties(this,{lastAdsRefreshTime:(new Date()).getTime(),adsRefreshMinInterval:a});var j=this.onnext.bind(this);var r=this.onprev.bind(this);var p=this.onplay.bind(this);var s=this.onstop.bind(this);ge('photonav_next')&&Event.listen($('photonav_next'),'click',j);ge('photonav_prev')&&Event.listen($('photonav_prev'),'click',r);if(this.displayStartShow)Event.listen(this.displayStartShow,'click',p);if(this.displayStopShow)Event.listen(this.displayStopShow,'click',s);Event.listen(this.img,'click',j);KeyEventController.registerKey('RIGHT',j);KeyEventController.registerKey('LEFT',r);PageTransitions.registerHandler(bind(this,'photosPageTransitionHandler'));if(URI.getRequestURI().getQueryData().ss)p();this.img.onload=null;if(ua.ie()<7)this.img.galleryimg=\"no\";this.cursor=q;this.requestPage(l);if(h){var i=bind(this,function(v){scribe_log(v?'photostream':'photostream_ajax',this.seq);},m!=undefined);onunloadRegister(i);onleaveRegister(i);}this.orig_params=URI.getRequestURI().getQueryData();}copy_properties(Photostream.prototype,{debug:bagofholding,setupDisplay:function(){copy_properties(this,{displayPhotoBox:$('photoborder').parentNode,displayPosition:$('photo_count'),displayPhototags:$('phototags_row'),displayTagBoxes:$('photo_tag_boxes'),displayComments:$('photocomment'),displayNext:ge('photo_form_next'),displayActions:$('photoactions'),photolink:$('myphotolink'),displayLoad:$('load_indicator'),displayContext:$('photoinalbum'),displayPublicLink:ge('public_link_photo'),displayStartShow:ge('photo_start_show'),displayStopShow:ge('photo_stop_show'),displayCaption:DOM.find($('photocaption_parent'),'div.photocaption_text')});},setupCaptions:function(h,f,g,a){var e=$('photocaption_parent');if(window.Photocaption){var b={typeaheadSource:(g||{}).typeaheadSource,successCallback:this.setDataFromCaption.bind(this),beginEditCallback:this.stopSlideshow.bind(this)};var d=this.album[this.cursor];var c=d?d.id:h;var f=d?d.pid:f;this.caption=new Photocaption(e,c,f,b,a);}},requestPage:function(a){if(this.fetchedPages[a])return;this.fetchedPages[a]=true;this.numFetchedPages++;this.pending++;new AsyncRequest().setURI(this.isSearch?'\/photo_search.php':'\/album.php').setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).setData(copy_properties(this.data,{page:a})).setHandler(bind(this,'didGetAlbumResponse',a)).send();},requestPhotoSuggestions:function(){var b={force_config:['photo_suggestions','photos_of',6],is_ajax:true,contexts:{5:{pid:this.album[this.cursor].pid,oid:this.album[this.cursor].id,contig:true}}};var a='\/pagelet\/generic.php\/EgoPagelet';this.netegoPagelet=new UIPagelet().setAllowCrossPageTransition(true).go(a,b);this.getPhotoSuggestions=false;},checkAndRefreshAds:function(){var a=(new Date()).getTime();if(a-this.lastAdsRefreshTime>=this.adsRefreshMinInterval)this.refreshAds();},refreshAds:function(){ads_refresh('','\/photo.php',null,true);this.lastAdsRefreshTime=(new Date()).getTime();},maxPagesToFetch:function(){return parseInt((this.album.length-1)\/this.pagesize,10)+1;},onnext:function(a){var b=(this.cursor+1)%this.album.length;if(this.slideshowActive)clearTimeout(this.lastTimeout);this.checkAndRefreshAds();if(!this.hideKeyPress(a)&&this.showPhoto(b)){var c=false;if(this.numFetchedPages==this.maxPagesToFetch()&&this.unseen<=this.endOfAlbumPhotos)this.showPhotoSuggestor();if(a.getTarget().id=='photonav_next')this.showKeyboardShortcutsDialog();return $E(a).kill();}},showPhotoSuggestor:function(){if(this.netegoPagelet){var a=DOM.scry($('content'),'div.ego_column');if(a.length>0){var b=this.netegoPagelet.getElement();if(DOM.scry(b,'img').length>0){DOM.setContent(a[0],b);for(var c=1;c<a.length;++c)DOM.empty(a[c]);var d=copy_properties(this.data,{num_photos:this.album.length});new AsyncSignal('\/ajax\/photos\/suggestor_log.php',d).send();this.netegoPagelet=null;this.lastAdsRefreshTime=new Date().getTime();}}}},hideKeyPress:function(b){if(window.Dialog&&window.Dialog.getCurrent()||this.caption&&this.caption.mentionsIsFocused()){event=$E(b);var a=event?Event.getKeyCode(event):-1;switch(a){case KEYS.RIGHT:case KEYS.LEFT:return true;}}return false;},setDataFromCaption:function(a){this.album[this.cursor].caption=a.rendered;this.album[this.cursor].caption_plaintext=a.plaintext;},slideshowTimeoutCallback:function(){var a=(this.cursor+1)%this.album.length;if(this.slideshowActive)if(this.album[a]){this.showPhoto(a);}else{this.requestPage(1+Math.floor(a\/this.pagesize));this.slideshowGoNext(500);}},onprev:function(a){var b=((this.cursor-1)+this.album.length)%this.album.length;this.checkAndRefreshAds();if(!this.hideKeyPress(a)&&this.showPhoto(b)){if(a.getTarget().id=='photonav_prev')this.showKeyboardShortcutsDialog();return $E(a).kill();}},onplay:function(a){this.slideshowActive=true;if(!this.slideshowEventsInited){var b=this.onSlideshowInputEvent.bind(this);Event.listen(window,{keypress:b,mousedown:b});this.slideshowEventsInited=true;}this.showSlideshowControls();this.slideshowGoNext(this.slideshowSpeed);return false;},onstop:function(a){this.stopSlideshow();return $E(a).kill();},stopSlideshow:function(){if(this.slideshowEventsInited&&this.displayStartShow){this.slideshowActive=false;clearTimeout(this.lastTimeout);this.hideSlideshowControls();}},onSlideshowInputEvent:function(a){if(!this.slideshowActive||!a)return;var c=a.getTarget();var b=true;switch(c){case 'my_photo':case 'photonav_next':case 'photonav_prev':case 'photo_start_show':case 'photo_stop_show':b=false;break;default:break;}if(b){this.stopSlideshow();clearTimeout(this.lastTimeout);}return true;},slideshowGoNext:function(a){clearTimeout(this.lastTimeout);this.lastTimeout=setTimeout(this.slideshowTimeoutCallback.bind(this),a);},showSlideshowControls:function(){CSS.show(this.displayStopShow);CSS.hide(this.displayStartShow);},hideSlideshowControls:function(){CSS.hide(this.displayStopShow);CSS.show(this.displayStartShow);},readPhotoState:function(){if(this.is_rendered&&this.album[this.cursor]){if(ua.safariPreWebkit()){this.album[this.cursor].tags=this.displayPhototags.innerHTML.replace(\/\\\\\\\/\/g,'\/');}else this.album[this.cursor].tags=this.displayPhototags.innerHTML;if(this.displayComments)this.album[this.cursor].comments=this.displayComments.innerHTML;if(this.displayActions)this.album[this.cursor].actions=this.displayActions.innerHTML;}},showPhoto:function(b){if(this.error)return false;if(this.caption&&this.caption.isUpdating())return true;var a=this.has_moved&&!this.album[this.cursor];this.has_moved=true;this.setCursor(b);var d=this.album[b];if(d){Arbiter.inform('photostream\/showPhoto',{node:{href:URI.getRequestURI().toString()},pid:d.pid,owner_id:d.id});var c={pid:d.pid,id:d.id,fbid:d.fbid};if(this.slideshowActive)c.ss='on';goURI(URI.getRequestURI().addQueryData(c).removeQueryData('alert'));}else{if(!a){this.showLoadIndicator();this.prepareToLeavePhoto();}this.requestPage(1+parseInt(b\/this.pagesize,10));}return true;},prepareToLeavePhoto:function(){if(!this.readied){this.readied=true;var a=env_get('ps_rate')||(5);this.queue.setOption('concurrency',a).ready(a);}if(ge('changessaved'))DOM.remove(ge('changessaved'));if(ge('photocrop_error'))DOM.remove(ge('photocrop_error'));if(window.PhotoPageTags)PhotoPageTags.resetInstructions();},setCursor:function(a){if(a===this.cursor)return;this.readPhotoState();this.is_rendered=false;this.cursor=a;this.updateCountText();},updateCountText:function(){var a=_tx(\"Photo {photo-number} of {total-count}\",{\"photo-number\":this.cursor+1,\"total-count\":this.album.length});this.displayPosition&&DOM.setContent(this.displayPosition,HTML(a));},showCursorPhotoWithInfo:function(){this.prepareToLeavePhoto();var f=this.album[this.cursor];var e=document.createElement('img');copy_properties(e.style,{display:'none'});if(!f.seen){var c=(parseInt(this.cursor\/this.pagesize)+1)*this.pagesize;c=Math.min(c,this.album.length);var g=((c-this.cursor)<=3);f.seen=true;--this.unseen;if(g&&!this.pending){var a=parseInt(this.cursor\/this.pagesize)+1;var b=null;for(var d=a+1;d<=this.maxPagesToFetch();d++)if(!this.fetchedPages[d]){b=d;break;}if(b===null)for(var d=1;d<a;d++)if(!this.fetchedPages[d]){b=d;break;}if(b!==null)this.requestPage(b);}}if(!this.photoLoadTimeout)this.photoLoadTimeout=setTimeout(this.showLoadIndicator.bind(this),750);e.seq=++this.seq;e.onload=async_callback(bind(this,'renderPhoto',e,f),'photo');e.src=f.src;},renderPhoto:function(b,c){if(b.seq<this.minseq){delete b;return;}this.hideLoadIndicator();this.minseq=b.seq;var a=this.img.id;if(window.photocrop)photocrop.destroy();b.style.display='';if(this.img.parentNode==null)this.img=$('myphoto');this.img.parentNode.appendChild(b);b.style.cursor=this.img.style.cursor;DOM.remove(this.img);this.img=b;this.img.id=a;Event.listen(this.img,'click',this.onnext.bind(this));this.displayCaption&&DOM.setContent(this.displayCaption,HTML(c.caption));this.displayPhototags&&DOM.setContent(this.displayPhototags,HTML(c.tags));this.displayTagBoxes&&DOM.setContent(this.displayTagBoxes,HTML(c.tag_boxes));this.displayComments&&DOM.setContent(this.displayComments,HTML(c.comments));this.displayActions&&DOM.setContent(this.displayActions,HTML(c.actions));this.displayContext&&DOM.setContent(this.displayContext,HTML(c.context_info));this.displayPublicLink&&DOM.setContent(this.displayPublicLink,HTML(c.public_link));if(this.caption){this.caption.setCanCaption(c.can_caption);this.caption.setCaptionData(c.id,c.pid,c.caption_plaintext);}this.is_rendered=true;if(window.PhotoTagController&&PhotoTagController.getInstance('myphoto')){PhotoTagController.getInstance('myphoto').setPhotoData(c.id,c.pid,c.fbid);}else PhotoTagViewer.getInstance('myphoto').setPhotoData(c.id,c.pid,c.fbid);if(this.slideshowActive)animation(this.img).from('opacity',0).to('opacity',1).duration(300).ondone(this.slideshowGoNext.bind(this,this.slideshowSpeed)).go();this.queue.ready();},didGetAlbumResponse:function(e,a){this.pending--;var f=a.getPayload();var j=(this.has_moved&&this.cursor!==null&&!this.album[this.cursor]);var c,i,d,h,g=f.data;for(var b=0;b<g.length;++b){data=g[b];h=(f.offset||(this.pagesize*(e-1)))+b;if((this.cursor===null||f.album_count)&&data.pid==this.pid)this.cursor=h;data.pos=h;data.seen=false;this.album[h]=data;this.jumps[data.fbid]=h;c=new Image();d=bind(c,function(k){this.src=k;},data.src);i=new Task(d);c.onload=i.didComplete.bind(i);this.queue.addTask(i);}this.unseen+=g.length;if(f.album_count){this.album.length=f.album_count;this.updateCountText();}if(j)this.showPhoto(this.cursor);if(this.getPhotoSuggestions)if(this.numFetchedPages==this.maxPagesToFetch())this.requestPhotoSuggestions(e);},photosPageTransitionHandler:function(b){var a=this.pageTransitionHandler(b);if(!a)Arbiter.inform('photostream\/showPhoto',{flush:true});return a;},pageTransitionHandler:function(b){var a=b.getQueryData();if(b.getPath()=='\/photo.php'){for(var c in this.orig_params)if(c!='pid'&&c!='fbid'&&(!this.isSearch||(c!='id'&&c!='psids'))&&this.orig_params[c]!=a[c])return false;if(a.alert!==undefined)return false;fbid=a.fbid;if(this.jumps[fbid]!==undefined){this.setCursor(this.jumps[fbid]);this.showCursorPhotoWithInfo();PageTransitions.transitionComplete();return true;}}return false;},showLoadIndicator:function(){CSS.addClass(this.displayLoad,'loading');animation(this.displayLoad).to('opacity',0).duration(0).go().to('opacity',1).duration(200).go();animation(this.img).to('opacity',0).duration(200).go();return this;},hideLoadIndicator:function(){if(this.photoLoadTimeout){clearTimeout(this.photoLoadTimeout);this.photoLoadTimeout=null;}animation(this.img).to('opacity',1).duration(0).go();CSS.removeClass(this.displayLoad,'loading');return this;},showKeyboardShortcutsDialog:function(){if(this.keyboardDialogViews!=0){new AsyncRequest('\/ajax\/photos\/keyboard_dialog.php').setData({count:this.keyboardDialogViews}).setMethod('POST').setAllowCrossPageTransition(true).send();this.keyboardDialogViews=0;}}});\n\nif (window.Bootloader) { Bootloader.done([\"js\\\/photos\\\/photostream.js\"]); }")