/*
HTTP Host: static.ak.fbcdn.net
Generated: August 2nd 2010 10:01:41 AM PDT
Machine: 10.138.16.183
Locale: nu_ll
Path: js/photos/photocaption.js
*/

((location=='about:blank'&&(window.parent.eval_global||window.parent.eval))||(window.eval_global||window.eval))("if (window.CavalryLogger) { CavalryLogger.start_js([\"js\\\/photos\\\/photocaption.js\"]); }\n\nfunction Photocaption(e,j,f,d,a){d=copy_properties({typeaheadSource:null,successCallback:null,beginEditCallback:null},d||{});this.displayCaption=DOM.find(e,'div.photocaption');this.displayCapText=DOM.find(e,'div.photocaption_text');this.displayCapIcon=ge('photocaption_editicon');this.displayEditCapText=DOM.find(e,'textarea.photocaption_edit_text');this.displayNoCaption=DOM.find(e,'div.photocaption_nocaption');this.displayEditCaption=DOM.find(e,'div.photocaption_edit');this.captionMode=Photocaption.READ;this.successCallback=d.successCallback;this.beginEditCallback=d.beginEditCallback;this.uid=j;this.pid=f;this.mentionsHasFocus=false;this.can_caption=a;var c=DOM.find(e,'a.photocaption_toggle');var h=DOM.find(e,'a.photocaption_nocaption_edit');var g=DOM.find(e,'.caption_save');var b=DOM.find(e,'.caption_cancel');if(d.typeaheadSource&&typeof(typeahead_mentions)!=='undefined')this.initializeMentions(d.typeaheadSource);var i=this.toggleCaption.bind(this);c&&(c.onmousedown=i);h&&(h.onclick=i);g&&(g.onclick=this.saveCaption.bind(this));if(b)b.onclick=function(k){this.setCaptionUpdating(false);return $E(k).kill();}.bind(this);this.cappt=this.getCaptionEditText();}Photocaption.READ=0;Photocaption.WRITE=1;Photocaption.UPDATING=2;copy_properties(Photocaption.prototype,{initializeMentions:function(c){if(ua.firefox()<3||ua.safariPreWebkit()||ua.opera())return;var d=this.getCaptionEditText();var a=$N('div',{className:'photocaption_mentions',contentEditable:true},document.createTextNode(d));DOM.replace(this.displayEditCapText,a);this.displayEditCapText=a;var b=new typeahead_mentions(a,c);this.getCaptionEditText=b.getMessage.bind(b);this.setCaptionEditText=b.setMessage.bind(b);this.setCaptionFocus=b.focusInput.bind(b);this.enableCaption=b.enable.bind(b);this.disableCaption=b.disable.bind(b);this.mentionsObj=b;a.onfocus=chain(function(e){this.mentionsHasFocus=true;}.bind(this),a.onfocus);a.onblur=chain(function(e){this.mentionsHasFocus=false;}.bind(this),a.onblur);},toggleCaption:function(a){if(this.captionMode==Photocaption.WRITE){this.captionMode=Photocaption.READ;this.displayCaptionUI();}else if(this.captionMode==Photocaption.READ){this.captionMode=Photocaption.WRITE;this.displayCaptionUI();}return $E(a).kill();},displayCaptionUI:function(){var a=this.captionMode;if(a==Photocaption.WRITE){this.beginEditCallback&&this.beginEditCallback();hide(this.displayCaption);hide(this.displayNoCaption);show(this.displayEditCaption);if(this.getCaption()){CSS.show(this.displayCapIcon);}else CSS.hide(this.displayCapIcon);this.setCaptionFocus();}else if(a==Photocaption.READ){hide(this.displayEditCaption);if(this.getCaption()){hide(this.displayNoCaption);show(this.displayCaption);if(this.can_caption){CSS.show(this.displayCapIcon);}else CSS.hide(this.displayCapIcon);}else{hide(this.displayCaption);CSS.hide(this.displayCapIcon);if(this.can_caption){show(this.displayNoCaption);}else hide(this.displayNoCaption);}}},saveCaption:function(b){if(this.captionMode!=Photocaption.WRITE)return;var a=trim(this.getCaptionEditText());if(a!=this.cappt){this.setCaptionUpdating(true);new AsyncRequest().setURI('\/ajax\/editphotocaption.php').setMethod('POST').setData({caption:a,oid:this.uid,pid:this.pid}).setHandler(this.saveCaptionResponse.bind(this)).setErrorHandler(this.saveCaptionError.bind(this)).send();}else this.setCaptionUpdating(false);return $E(b).kill();},saveCaptionResponse:function(a){var b=a.getPayload();this.cappt=b.plaintext;DOM.setContent(this.displayCapText,HTML(b.rendered));this.successCallback&&this.successCallback(b);this.setCaptionUpdating(false);this.setCaptionEditText(this.cappt);},saveCaptionError:function(a){this.setCaptionUpdating(false);AsyncResponse.verboseErrorHandler(a);},setCaptionData:function(c,b,a){this.setCaptionUpdating(false);this.uid=c;this.pid=b;this.cappt=a;this.setCaptionEditText(a);this.displayCaptionUI();},getCaption:function(){return this.displayCapText.innerHTML;},setCaptionUpdating:function(a){if(a){this.captionMode=Photocaption.UPDATING;CSS.addClass(this.displayEditCapText,'updating');this.disableCaption();}else{this.captionMode=Photocaption.READ;CSS.removeClass(this.displayEditCapText,'updating');this.enableCaption();this.displayCaptionUI();}},isUpdating:function(){return this.captionMode==Photocaption.UPDATING;},isEditing:function(){return this.captionMode==Photocaption.WRITE;},mentionsIsFocused:function(){return this.isEditing()&&this.mentionsHasFocus;},setCanCaption:function(a){this.can_caption=a;},setCaptionEditText:function(a){this.displayEditCapText.value=HTML(a);},getCaptionEditText:function(){return this.displayEditCapText.value;},setCaptionFocus:function(){this.displayEditCapText.focus();},enableCaption:function(){this.displayEditCapText.disabled=false;},disableCaption:function(){this.displayEditCapText.disabled=true;}});\n\nif (window.Bootloader) { Bootloader.done([\"js\\\/photos\\\/photocaption.js\"]); }")